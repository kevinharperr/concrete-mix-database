{% extends 'base.html' %}
{% load static crispy_forms_tags %}
{% load url_params %}
{% load user_filters %}

{% block extra_head %}
    {{ block.super }}
    {{ composition_form.media.css }}
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    {{ composition_form.media.js }}
    <script>
        $(document).ready(function() {
            // Initialize Select2 with CSRF token handling
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                    }
                }
            });
            
            // Additional debug logging for Select2 errors
            $(document).on('select2:error', function(e) {
                console.error('Select2 error:', e);
            });
        });
    </script>
{% endblock %}

{% block title %}Mix Details: {{ mix.mix_code|default:mix.mix_id }} - Concrete Mix Database{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Mix Details: {{ mix.mix_code|default:mix.mix_id }}</h1>
        <div>
            {% if can_edit %}
            <a href="{% url 'concrete_mix_app:edit_mix' pk=mix.pk %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-edit me-1"></i> Edit Mix
            </a>
            {% endif %}
            {% if is_admin %}
            <a href="{% url 'concrete_mix_app:delete_mix' pk=mix.pk %}" class="btn btn-outline-danger">
                <i class="fas fa-trash-alt me-1"></i> Delete Mix
            </a>
            {% endif %}
        </div>
    </div>
    <hr>

    {# General Info Card #}
    <div class="card mb-4">
        <div class="card-header">General Information</div>
        <div class="card-body">
            <p><strong>Mix Code:</strong> {{ mix.mix_code|default:"N/A" }}</p>
            <p><strong>Date Created:</strong> {{ mix.date_created|date:"Y-m-d"|default:"N/A" }}</p>
            <p><strong>Region:</strong> {{ mix.region|default:"N/A" }}</p>
            <p><strong>Target Strength:</strong> {{ mix.target_strength_mpa|default:"N/A" }} MPa</p>
            <p><strong>Target Workability:</strong> {{ mix.target_workability_mm|default:"N/A" }} mm</p>
            <p><strong>Source Dataset:</strong> {{ mix.source_dataset|default:"N/A" }}</p>
            {% if mix.reference %}
                <p><strong>Reference:</strong> {{ mix.reference.title|default:"No Title" }} ({{ mix.reference.author|default:"Unknown Author" }}, {{ mix.reference.year|default:"N/A" }})</p>
            {% else %}
                <p><strong>Reference:</strong> N/A</p>
            {% endif %}
            <p><strong>Notes:</strong></p>
            <pre class="bg-light p-2 rounded">{{ mix.notes|default:"None" }}</pre>
        </div>
    </div>

    <div class="row">
        <!-- Mix Composition -->
        <div class="col-lg-7 mb-4">
            <div class="card h-100">
                <div class="card-header">Mix Composition</div>
                <div class="card-body">
                    {% if compositions %}
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Qty (kg/m³)</th>
                                    <th>W/C (B)</th>
                                    <th style="width: 80px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for comp in compositions %}
                                <tr>
                                    <td>
                                        {% if comp.material %}
                                            {# Link to material detail view #}
                                            <a href="{% url 'concrete_mix_app:material_detail' pk=comp.material.pk %}">
                                                {{ comp.material.name|default:"?" }}
                                            </a>
                                            <small class="text-muted">({{ comp.material.material_type|default:"?" }})</small>
                                        {% else %}
                                            Unknown Material
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ comp.quantity_kg_m3|floatformat:3|default:"-" }}</td>
                                    <td class="text-end">{{ comp.w_c_ratio|default:comp.w_b_ratio|floatformat:2|default:"-" }}</td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm">
                                            {% if can_contribute %}
                                            <a href="{% url 'concrete_mix_app:edit_composition' mix_pk=mix.pk comp_pk=comp.pk %}" 
                                                class="btn btn-outline-primary btn-sm" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% endif %}
                                            {% if is_admin %}
                                            <a href="{% url 'concrete_mix_app:delete_composition' mix_pk=mix.pk comp_pk=comp.pk %}" 
                                                class="btn btn-outline-danger btn-sm" title="Delete">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">No composition data available.</p>
                    {% endif %}

                    {% if can_contribute %}
                    <hr>
                    <h5>Add Material to Mix</h5>
                    <form method="post" action="{% url 'concrete_mix_app:add_composition' mix_pk=mix.pk %}">
                        {% csrf_token %}
                        {{ composition_form|crispy }}
                        <button type="submit" class="btn btn-success btn-sm mt-2">Add Material</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sustainability Metrics -->
        <div class="col-lg-5 mb-4">
            <div class="card h-100">
                <div class="card-header">Sustainability Metrics</div>
                <div class="card-body">
                    {% if sustainability_metrics %}
                        {% for metric in sustainability_metrics %}
                            <p><strong>CO₂ Footprint:</strong> {{ metric.co2_footprint_kg_per_m3|floatformat:1|default_if_none:"N/A" }} kg/m³</p>
                            <p><strong>Cost:</strong> {{ metric.cost_per_m3|floatformat:2|default_if_none:"N/A" }} /m³</p>
                            <p><strong>GWP:</strong> {{ metric.global_warming_potential_kg_co2e|floatformat:1|default_if_none:"N/A" }} kg CO₂e</p>
                            <p><strong>Embodied Energy:</strong> {{ metric.embodied_energy_mj_per_m3|floatformat:1|default_if_none:"N/A" }} MJ/m³</p>
                            <p><strong>Clinker Factor:</strong> {{ metric.clinker_factor|floatformat:2|default_if_none:"N/A" }}</p>
                            <p><strong>SCM %:</strong> {{ metric.scm_percentage|floatformat:1|default_if_none:"N/A" }}</p>
                            <p><strong>Recyclability Index:</strong> {{ metric.recyclability_index|floatformat:2|default_if_none:"N/A" }}</p>
                            {% if not forloop.last %}<hr>{% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No sustainability data available.</p>
                    {% endif %}
                    
                    {% if can_contribute %}
                    <hr>
                    <h5>Add Sustainability Metrics</h5>
                    <form method="post" action="{% url 'concrete_mix_app:mix_detail' pk=mix.pk %}">
                         {% csrf_token %}
                         <div class="accordion" id="sustainabilityAccordion">
                             <div class="accordion-item">
                                 <h2 class="accordion-header" id="sustainabilityFormHeading">
                                     <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sustainabilityFormCollapse" aria-expanded="false" aria-controls="sustainabilityFormCollapse">
                                        Click to expand form
                                     </button>
                                 </h2>
                                 <div id="sustainabilityFormCollapse" class="accordion-collapse collapse" aria-labelledby="sustainabilityFormHeading" data-bs-parent="#sustainabilityAccordion">
                                     <div class="accordion-body">
                                         {{ sustainability_form|crispy }}
                                     </div>
                                 </div>
                             </div>
                         </div>
                         <input type="hidden" name="add_sustainability" value="1">
                         <button type="submit" class="btn btn-success btn-sm mt-2">Add Metrics</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Results -->
    <div class="card mb-4">
        <div class="card-header">Performance Results</div>
        <div class="card-body">
            {% if performance_results %}
                <table class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Test Type</th>
                            <th>Age (Days)</th>
                            <th>Value</th>
                            <th>Unit</th>
                            <th>Conditions</th>
                            <th>Specimen</th>
                            <th style="width: 80px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for result in performance_results %}
                        <tr>
                            <td>{{ result.test_type|default:"N/A" }}</td>
                            <td>{{ result.test_age_days|default:"N/A" }}</td>
                            <td>{{ result.test_value|floatformat:1|default:"N/A" }}</td>
                            <td>{{ result.test_unit|default:"N/A" }}</td>
                            <td>{{ result.test_conditions|default:"N/A" }}</td>
                            {# TODO: Link Specimen to its detail page if created #}
                            <td>{{ result.specimen|default:"N/A" }}</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    {% if can_contribute %}
                                    <a href="{% url 'concrete_mix_app:edit_performance_result' mix_pk=mix.pk perf_pk=result.pk %}" 
                                       class="btn btn-outline-primary btn-sm" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    {% if is_admin %}
                                    <a href="{% url 'concrete_mix_app:delete_performance_result' mix_pk=mix.pk perf_pk=result.pk %}" 
                                       class="btn btn-outline-danger btn-sm" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">No performance results available.</p>
            {% endif %}
            {% if can_contribute %}
            <hr>
            <h5>Add Performance Result</h5>
            <form method="post" action="{% url 'concrete_mix_app:mix_detail' pk=mix.pk %}">
                 {% csrf_token %}
                 {{ performance_form|crispy }}
                 <input type="hidden" name="add_performance" value="1">
                 <button type="submit" class="btn btn-success btn-sm mt-2">Add Result</button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Durability Results -->
    <div class="card mb-4">
        <div class="card-header">Durability Results</div>
        <div class="card-body">
             {% if durability_results %}
                <table class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Test Type</th>
                            <th>Age (Days)</th>
                            <th>Value</th>
                            <th>Unit</th>
                            <th>Conditions</th>
                            <th>Specimen</th>
                            <th style="width: 80px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for result in durability_results %}
                        <tr>
                            <td>{{ result.test_type|default:"N/A" }}</td>
                            <td>{{ result.test_age_days|default:"N/A" }}</td>
                            <td>{{ result.test_value|floatformat:1|default:"N/A" }}</td>
                            <td>{{ result.test_unit|default:"N/A" }}</td>
                            <td>{{ result.test_conditions|default:"N/A" }}</td>
                            {# TODO: Link Specimen to its detail page if created #}
                            <td>{{ result.specimen|default:"N/A" }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">No durability results available.</p>
            {% endif %}
            {% if can_contribute %}
            <hr>
            <h5>Add Durability Result</h5>
            <form method="post" action="{% url 'concrete_mix_app:mix_detail' pk=mix.pk %}">
                 {% csrf_token %}
                 {{ durability_form|crispy }}
                 <input type="hidden" name="add_durability" value="1">
                 <button type="submit" class="btn btn-success btn-sm mt-2">Add Result</button>
            </form>
            {% endif %}
        </div>
    </div>

     <a href="{% url 'concrete_mix_app:dashboard' %}" class="btn btn-outline-primary mt-3 mb-3">Back to Dashboard</a>
     <a href="{% url 'concrete_mix_app:mix_list' %}" class="btn btn-outline-secondary mt-3 mb-3">Back to Search</a>

</div>
{% endblock %}
