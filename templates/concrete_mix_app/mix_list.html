{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load url_params %}

{% block title %}Search Concrete Mixes - Concrete Mix Database{% endblock %}

{% block extra_head %}
<style>
  th a.sort-link {
    color: inherit; text-decoration: none; display: block;
  }
  th a.sort-link:hover {
    color: #0d6efd; text-decoration: underline;
  }
  th span.sort-arrow {
    display: inline-block; width: 0.8em; text-align: right;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Search Concrete Mixes</h1>
    <hr>

    {# Filter Form - Manually render fields, excluding 'ordering' #}
    <form method="get" class="mb-4 p-3 border rounded bg-light">
        {% get_current_url_params exclude='export,page,sort' as export_params %}
        <div class="row g-3 align-items-end mb-3">
             {% for field in filter.form %}
                {% if field.name != 'ordering' %} {# Skip the ordering field #}
                    {% if field.is_hidden %}
                        {{ field }}
                    {% else %}
                        <div class="col-md-4 col-lg-3">
                            {{ field|as_crispy_field }}
                        </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
        <div class="row">
            <div class="col-12 col-sm-auto mb-2">
                <button type="submit" class="btn btn-primary w-100">Search</button>
            </div>
             <div class="col-12 col-sm-auto mb-2">
                <a href="{% url 'concrete_mix_app:mix_list' %}" class="btn btn-secondary w-100">Clear</a>
            </div>
             <div class="col-12 col-sm-auto mb-2">
                 <a href="?{{ export_params }}{% if current_ordering %}&sort={{ current_ordering }}{% endif %}&export=csv" class="btn btn-success w-100">Export Results (CSV)</a>
            </div>
        </div>
    </form>

    {# Results Table #}
    {% if page_obj %}
        <p>Found {{ page_obj.paginator.count }} mix{{ page_obj.paginator.count|pluralize }} matching your criteria.</p>

        {# Get params excluding page and sort for sorting links #}
        {% get_current_url_params exclude='page,sort' as current_params_nosort_no_sort %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead>
                    <tr>
                        {% url 'concrete_mix_app:mix_list' as base_url %}
                        {# Mix Code Header - Link toggles natural sort using 'sort' param #}
                        {% with sort_param_value='mix_code_natural' display_name='Mix Code/ID' %}
                            <th><a href="{{ base_url }}?{{ current_params_nosort_no_sort }}&sort={% if current_ordering == sort_param_value %}-{% endif %}{{ sort_param_value }}" class="sort-link">{{ display_name }}
                                <span class="sort-arrow">{% if current_ordering == sort_param_value %}&#9660;{% elif current_ordering == '-'|add:sort_param_value %}&#9650;{% endif %}</span></a>
                            </th>
                        {% endwith %}
                        {# Other headers - not sortable #}
                        <th>Region</th>
                        <th>Comp. Str. (MPa)</th>
                        <th>Test Age (Days)</th>
                        <th>Date Created</th>
                        <th>Source Dataset</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mix in page_obj %}
                    <tr>
                        <td><a href="{% url 'concrete_mix_app:mix_detail' pk=mix.pk %}">{{ mix.mix_code|default:mix.mix_id }}</a></td>
                        <td>{{ mix.region|default:"-" }}</td>
                        {% with first_result=mix.performance_results.all|first %}
                            <td class="text-end">{{ first_result.test_value|floatformat:1|default:"-" }}</td>
                            <td class="text-center">{{ first_result.test_age_days|default:"-" }}</td>
                        {% endwith %}
                        <td class="text-center">{{ mix.date_created|date:"Y-m-d"|default:"-" }}</td>
                        <td>{{ mix.source_dataset|default:"-" }}</td>
                        <td class="text-center">
                            <a href="{% url 'concrete_mix_app:mix_detail' pk=mix.pk %}" class="btn btn-sm btn-outline-primary">View</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No concrete mixes found matching your criteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% include "includes/pagination.html" with current_params=current_params_nosort_no_sort sort_param=current_ordering %}

    {% else %}
         <p class="text-center text-muted">No concrete mixes found.</p>
    {% endif %}

</div>
{% endblock %}
